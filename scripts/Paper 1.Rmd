---
title: "Paper 1"
author: "Marion Nyberg"
date: "27/04/2022"
output: html_document
---

```{r setup, include=FALSE}
library(data.table)
library(janitor)
library(plotly)
library(plyr)
library(dplyr)
library(knitr)
library(tidyverse)
#library(devtools)
library(openair)
library(tidyr)
library(naniar)
library(forecast)
library(kableExtra)
library(htmltools)
library(ggpubr)
library(rstatix)
library(broom)
library(gtable)
library(gridExtra)
library(cowplot)

rm(list = ls())
#wd <- ("R:/SET/PlantSci/Shared Work Spaces/Ecology/Flux/SP_data")
#setwd(wd)
#knitr::opts_knit$set(root.dir = wd)
```

Below are conversion factors and functions used in the markdown file:

```{r functions and conversions}
d.avg <- 1800 * 48 #60 secs * 60 mins * 24 hours (# of secs in day)
co2_conv <- 12.01/(10^6) 

tidy.csv <- function(x){
  input <- x[-c(1,2),] %>%
    row_to_names(., 1)
}  

gofC.f <- function(x){ # function to convert to mean 30 minute to g of C
  (x*d.avg)*co2_conv
}

gtomg.f <- function(x){ # function to convert from g to mg
  x*1000
}
```

```{r read data and some data class cleaning, include=FALSE}
input <- fread("R:/SET/PlantSci/Shared Work Spaces/Ecology/Flux/SP_data/PFP/L6/SilverPlains_L6.csv", header = FALSE, na.strings = "-9999") 
input <- tidy.csv(input)

input <- input %>% select(xlDateTime, Fe, Fg_Av, Fh, Fld, Flu, Fn, Fsu, Fsd, Precip, RH, Sws, Ta, Ts, VPD, Wd_SONIC_Av, Ws_SONIC_Av,ER_LT_all, GPP_LT,GPP_SOLO, NEE_LT ) # select met variables (add more as needed)
colnames(input) <- c('Timestamp', 'LE', 'G', 'H', 'LWin', 'LWout', 'NETRAD', 'SWout', 'SWin', 'Precip', 'RH', 'SWC', 'Ta', 'Ts', 'VPD', 'WD', 'WS', 'ER_LT', 'GPP_LT', 'GPP_SOLO', 'NEE_LT')

input$Timestamp <- as.POSIXct(input$Timestamp, format= "%d/%m/%Y %H:%M") # change from character to POSIXct
input[,2:21] <- as.data.frame(sapply(input[,2:21], as.numeric)) # convert data frame from character to numeric

input$jday <-yday(input$Timestamp) # add jday
input$Year <- year(input$Timestamp) # extract year
input$Year <- as.factor(input$Year) # convert year from integer to factor
input$month <- month(as.POSIXct(input$Timestamp)) # extract month
input$month <- as.factor(input$month)
```

```{r weird stuff in data filtered out}
input$SWin <- ifelse(input$SWin < 0, NA, input$SWin)
```

```{r create daily mean dataframe, include=FALSE}
# add variables to this daily df as needed
input.daily <- input %>%
  drop_na(Timestamp) %>% # some NAs in the Timestamp for some reason. Need to look into
  ddply(c("Year", "jday", "month"), summarise,
        Precip = sum(Precip, na.rm = TRUE),
        SWin = sum(SWin),
        Ta.mean = mean(Ta, na.rm = TRUE),
        Ta.max = max(Ta, na.rm = TRUE),
        Ta.min = min(Ta, na.rm = TRUE),
        Ts.mean = mean(Ts, na.rm = TRUE),
        Ts.max = max(Ts, na.rm = TRUE),
        Ts.min = min(Ts, na.rm = TRUE),
        SWC = mean(SWC, na.rm = TRUE),
        RH = mean(RH, na.rm = TRUE),
        VPD = mean(VPD, na.rm = TRUE),
        NEE_LT = mean(NEE_LT, na.rm = TRUE), #daily average umol m-2 s-1
        ER_LT = mean(ER_LT, na.rm = TRUE),
        GPP_LT = mean(GPP_LT, na.rm = TRUE)) %>%
  mutate(NEE_LT.gC = gofC.f(NEE_LT),  #converts to daily total NEE in g C CO2
         ER_LT.gC = gofC.f(ER_LT),
         GPP_LT.gC = gofC.f(GPP_LT))

input.daily$month <- as.numeric(input.daily$month) 
input.daily$month <- month.abb[input.daily$month]

```

## Results {.tabset}

### Precipitation

```{r Precipitation, echo=FALSE, message = FALSE, fig.width = 8, fig.height = 4}
(SP.rain <- input.daily %>% mutate(Precip = replace_na(Precip, 0)) %>%
  ddply(c("Year", "month"), summarise,
  monthly.total = sum(Precip)) %>%
  ggplot(., aes(x = month, y = monthly.total, group = Year, fill = Year)) +
       #scale_x_discrete(limits = month.abb) +
  geom_col(position = "dodge") + 
  ylab("Monthly rainfall (mm)")+
  xlab("Month")+
   scale_x_discrete(limits = month.abb) +
  theme_classic()+
  theme(axis.title = element_text(size = 14),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 14)))


#below is precip data from liaweenee - it only goes up to Jan 2022 right now
rainfall_L <- read.csv("R:/SET/PlantSci/Shared Work Spaces/Ecology/Peoples files/Marion Nyberg/PhD/Rainfall/rainfall.csv")
rainfall_L <- rainfall_L[-4]
colnames(rainfall_L)[4] <- "Precip"
rainfall_L$Year <- as.factor(rainfall_L$Year)
rainfall_L <- rainfall_L %>% filter(Year == 2019)
colnames(rainfall_L)[1] <- "jday"
colnames(rainfall_L)[3] <- "month"
rainfall_L$Site <- "L"
rainfall_L <- rainfall_L %>% filter(month >= 9)
rainfall_L$month <- as.numeric(rainfall_L$month) 
rainfall_L$month<- month.abb[rainfall_L$month]

rainfall_L %>% mutate(Precip = replace_na(Precip, 0)) %>%
  ddply(c("Year", "month"), summarise,
  monthly.total = sum(Precip)) %>%
  ggplot(., aes(x = month, y = monthly.total, group = Year, fill = Year)) +
       scale_x_discrete(limits = month.abb) +
  geom_col(position = "dodge") + 
  ylab("Monthly rainfall (mm)")+
  xlab("month")+
  theme_classic()

rainfall.SP <- input.daily %>% select(Precip, jday, month, Year)
rainfall.SP$Site <- "SP"
rainfall <- rbind(rainfall_L, rainfall.SP)

rainfall %>%  mutate(Precip = replace_na(Precip, 0)) %>%
  ddply(c("Year", "month"), summarise,
  monthly.total = sum(Precip)) %>%
  ggplot(., aes(x = month, y = monthly.total, group = Year, fill = Year)) +
       scale_x_discrete(limits = month.abb) +
  geom_col(position = "dodge") + 
  ylab("Monthly rainfall (mm)")+
  xlab("Month")+
  theme_classic()+
    theme(axis.title = element_text(size = 14),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 14))


```


### Air and soil temperature


Mean daily air temperature (top) and monthly (bottom)
Mean daily air temperature

```{r Air temperature, echo=FALSE, message = FALSE, fig.width = 8, fig.height = 4}
TA <- ggplot(input.daily, aes(x = jday, y = Ta.mean, group = Year)) +
  geom_line(aes(color = Year), size =1)+
    xlab("Julian day of year")+
    ylab("Air temperature (°C)")+
     #geom_ribbon(aes(ymin=Ta.min, ymax=Ta.max), alpha=.3, linetype=0) +
  theme_classic()+
    theme(axis.title = element_text(size = 14),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 14))

(TS <- ggplot(input.daily, aes(x = jday, y = Ts.mean, group = Year)) +
  geom_line(aes(color = Year), size =1)+
    xlab("Julian day of year")+
    ylab("Soil temperature (°C)")+
     #geom_ribbon(aes(ymin=Ta.min, ymax=Ta.max), alpha=.3, linetype=0) +
  theme_classic()+
    theme(axis.title = element_text(size = 14),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 14)))

ggplotly(ggplot(input.daily, aes(x = jday, y = Ta.max, group = Year)) +
  geom_line(aes(color = Year))+
  theme_classic())

ggplotly(ggplot(input.daily, aes(x = jday, y = Ta.min, group = Year)) +
  geom_line(aes(color = Year))+
  theme_classic())
```

### VPD

```{r VPD, echo=FALSE, message = FALSE, fig.width = 10, fig.height = 4}
ggplotly(ggplot(input.daily, aes(x = as.Date(jday, origin = ("2020-01-01")), y = VPD, group = Year)) +
  geom_line(aes(color = Year))+
  scale_x_date(date_labels = "%b", date_breaks = "1 month") +
  xlab("Month")+
  theme_classic())
```


### SWC

```{r, echo=FALSE, message = FALSE, fig.width = 8, fig.height = 4}
(SWC <- ggplot(input.daily, aes(jday, SWC, group = Year)) +
  geom_line(aes(color = Year), size = 1.5)+
  xlab('Julian day of year') +
  ylab('SWC %') +
  theme_classic() + 
    theme(axis.title = element_text(size = 14),
          axis.text = element_text(size = 13),
          legend.text = element_text(size = 13),
          legend.title = element_text(size = 14)))
```



```{r, fig.width = 10, fig.height = 6}
Legend.met<- get_legend(SP.rain+ theme(legend.position = 'right'))

Fig1 <- plot_grid(SP.rain + theme(legend.position="none"), TA+ theme(legend.position="none"),
             SWC+ theme(legend.position="none"), TS+ theme(legend.position="none"), ncol = 2, rel_heights = c(0.5, 0.5, 0.5, 0.5))


Fig1
tiff("Fig1.tiff", units="in", width=10, height=6,  res=300)
print(Fig1)
dev.off()


Legend.met
```

```{r add seasons, include=FALSE}
rainfall$season <- "" # add season variable

# define seasons
winter <- (rainfall$month == "6" | rainfall$month == "7" | rainfall$month == "8")
spring <- (rainfall$month == "9" | rainfall$month == "10" | rainfall$month == "11")
earlysummer <- (rainfall$month == "12")
latesummer <- (rainfall$month == "1" | rainfall$month == "2")
autumn <- (rainfall$month == "3" | rainfall$month == "4" | rainfall$month == "5")

rainfall$season[winter] <- "Winter"
rainfall$season[spring] <- "Spring"
rainfall$season[earlysummer] <- "EarlySummer"
rainfall$season[latesummer] <- "LateSummer"
rainfall$season[autumn] <- "Autumn"

rainfall$season <- factor(rainfall$season , levels=c('EarlySummer','LateSummer', 'Autumn', 'Winter', 'Spring'))

input.daily$season <- "" # add season variable

# define seasons
winter <- (input.daily$month == "6" | input.daily$month == "7" | input.daily$month == "8")
spring <- (input.daily$month == "9" | input.daily$month == "10" | input.daily$month == "11")
earlysummer <- (input.daily$month == "12")
latesummer <- (input.daily$month == "1" | input.daily$month == "2")
autumn <- (input.daily$month == "3" | input.daily$month == "4" | input.daily$month == "5")

input.daily$season[winter] <- "Winter"
input.daily$season[spring] <- "Spring"
input.daily$season[earlysummer] <- "EarlySummer"
input.daily$season[latesummer] <- "LateSummer"
input.daily$season[autumn] <- "Autumn"

input.daily$season <- factor(input.daily$season , levels=c('EarlySummer','LateSummer', 'Autumn', 'Winter', 'Spring'))
```

```{r create rainfall summary}
rainfall.summary <- rainfall %>% ddply(c("Year", "Site", "month"), summarise,
                                       monthly.sum = sum(Precip, na.rm = TRUE))

rainfall%>% ddply(c("Year", "season"), summarise,
                    seasonal.sum = sum(Precip, na.rm = TRUE))

rainfall.summary %>% 
  ggplot(., aes(x = month, y = monthly.sum, group = Year, fill = Site)) +
  geom_col(position = "dodge", aes(fill = Year)) + 
  ylab("Monthly rainfall (mm)")+
  xlab("month")+
  theme_classic()
```


```{r seasonal NEE}
NEE.summary <- input.daily %>% ddply(c("Year", "month"), summarise,
                                       monthly.sum = sum(NEE_LT.gC))

GPP.summary <- input.daily %>% ddply(c("Year", "month"), summarise,
                                       monthly.sum = sum(GPP_LT.gC))

ER.summary <- input.daily %>% ddply(c("Year", "month"), summarise,
                                       monthly.sum = sum(ER_LT.gC))


Ts.summary <- input.daily %>% ddply(c("Year", "month"), summarise,
                                       monthly.mean = mean(Ts.mean))

# check when switches from sink to source

NEE.summary %>% 
  ggplot(., aes(x = month, y = monthly.sum, group = Year, fill = Site)) +
  geom_col(position = "dodge", aes(fill = Year)) + 
         scale_x_discrete(limits = month.abb) +

  ylab("Monthly NEE")+
  xlab("month")+
  theme_classic()

GPP.summary %>%
  ggplot(., aes(x = month, y = monthly.sum, group = Year, fill = Site)) +
  geom_col(position = "dodge", aes(fill = Year)) + 
  ylab("Monthly GPP")+
  xlab("month")+
  theme_classic()

ER.summary %>%
  ggplot(., aes(x = month, y = monthly.sum, group = Year, fill = Site)) +
  geom_col(position = "dodge", aes(fill = Year)) + 
  ylab("Monthly ER")+
  xlab("month")+
  theme_classic()

Ts.summary %>%
  ggplot(., aes(x = month, y = monthly.mean, group = Year, fill = Site)) +
  geom_col(position = "dodge", aes(fill = Year)) + 
  ylab("Monthly ER")+
  xlab("month")+
  theme_classic()
```

```{r cumulative fluxes, fig.width = 10, fig.height = 6}
cum.co2fluxes <- input.daily %>%
  select(NEE_LT.gC, GPP_LT.gC, ER_LT.gC, jday, Year, month) %>% 
  group_by(Year) %>% 
  mutate(NEEcum = cumsum(NEE_LT.gC),
         GPPcum = cumsum(GPP_LT.gC),
         ERcum = cumsum(ER_LT.gC))

(NEEcum.p <-cum.co2fluxes %>% 
  ggplot(., aes(jday, NEEcum, color = Year)) +
  geom_line(size = 1)+
  ylab(bquote('Cumulative NEE (g C' ~m^-2~')'))+
  xlab("Julian day of year")+
  theme_classic()+ 
    theme(axis.title = element_text(size = 14),
          axis.text = element_text(size = 13),
          legend.position = "none"))

(NEE.time <- input.daily %>% 
  ggplot(., aes(jday, NEE_LT.gC, color = Year)) +
  geom_line(size = 1)+
  ylab(bquote('Cumulative NEE (g C' ~m^-2~ day^-1*')'))+
  xlab("Julian day of year")+
  theme_classic()+ 
    theme(axis.title = element_text(size = 14),
          axis.text = element_text(size = 13),
          legend.position = "none"))

(NEE.bar <- NEE.summary %>% 
  ggplot(., aes(x = month, y = monthly.sum, group = Year, fill = Site)) +
  geom_col(position = "dodge", aes(fill = Year)) + 
         scale_x_discrete(limits = month.abb) +
  ylab(bquote('Total monthly NEE (g C' ~m^-2~')'))+
  xlab("Month")+
  theme_classic() + 
    theme(axis.title = element_text(size = 14),
          axis.text = element_text(size = 13),
          legend.position = "none"))


(GPPcum.p <-cum.co2fluxes %>% 
  ggplot(., aes(jday, GPPcum, color = Year)) +
  geom_line(size = 1)+
  ylab(bquote('Cumulative GPP (g C' ~m^-2~')'))+
  xlab("Julian day of year")+
  theme_classic()+ 
    theme(axis.title = element_text(size = 14),
          axis.text = element_text(size = 13),
          legend.position = "none"))

(ERcum.p <-cum.co2fluxes %>% 
  ggplot(., aes(jday, ERcum, color = Year)) +
  geom_line(size =1)+
  ylab(bquote('Cumulative ER (g C' ~m^-2~')'))+
  xlab("Julian day of year")+
  theme_classic()+ 
    theme(axis.title = element_text(size = 14),
          axis.text = element_text(size = 13),
          legend.position = "none"))


Fig2 <- plot_grid(NEE.bar, NEEcum.p,
             GPPcum.p, ERcum.p, ncol = 2, rel_heights = c(0.5, 0.5, 0.5, 0.5))


Fig2
tiff("Fig2.tiff", units="in", width=10, height=6,  res=300)
print(Fig2)
dev.off()

```